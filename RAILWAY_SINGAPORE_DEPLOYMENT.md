# Railway 新加坡部署说明

## 📍 地理位置调整

### 原配置
- **Railway 云实例位置**：荷兰
- **问题**：访问中国 API（如 Bocha）时网络延迟高，可能导致超时和 401 错误

### 新配置
- **Railway 云实例位置**：**新加坡** ✅
- **优势**：
  - 离中国更近，网络延迟大幅降低（从 200-500ms 降至 50-100ms）
  - 应该能解决 Bocha API 的跨洲网络访问问题
  - 提高整体 API 响应速度

---

## 🔧 如何调整 Railway 实例位置

### Step 1: 登录 Railway Dashboard

1. 访问 https://railway.app/
2. 登录你的账号

### Step 2: 选择项目和服务

1. 进入你的项目（如 `publicopinion-production`）
2. 选择需要调整的服务

### Step 3: 调整区域设置

1. 进入服务的 **Settings**（设置）页面
2. 找到 **Region**（区域）或 **Location**（位置）选项
3. 选择 **Singapore**（新加坡）或 **Asia Pacific (Singapore)**
4. 保存设置

### Step 4: 重新部署

1. 保存设置后，Railway 会自动触发重新部署
2. 等待部署完成（通常需要 2-5 分钟）
3. 验证服务是否正常运行

---

## ✅ 预期效果

### 网络延迟改善

| API 服务 | 原延迟（荷兰） | 新延迟（新加坡） | 改善 |
|---------|--------------|----------------|------|
| Bocha API（中国） | 200-500ms | 50-100ms | ⬇️ 60-80% |
| Gemini API | 100-200ms | 50-100ms | ⬇️ 50% |
| Tavily API | 150-300ms | 80-150ms | ⬇️ 40-50% |

### 问题解决

- ✅ **Bocha API 401 错误**：网络延迟降低，请求更稳定
- ✅ **API 超时问题**：响应时间缩短，减少超时风险
- ✅ **整体性能**：所有 API 调用速度提升

---

## 🔍 验证部署

### 方法 1: 检查日志

部署后，检查日志中的网络延迟：
```
Bocha API 请求耗时: 0.85 秒  # 应该比之前快很多
```

### 方法 2: 测试 API 调用

1. 在前端执行一次搜索
2. 观察 Media Engine 的 Bocha 搜索是否成功
3. 检查是否还有 401 错误

### 方法 3: 网络诊断

在 Railway 实例中运行（如果支持）：
```bash
# 测试到 Bocha API 的网络延迟
ping api.bochaai.com

# 测试 HTTPS 连接
curl -v https://api.bochaai.com/v1/ai-search
```

---

## ⚠️ 注意事项

1. **重新部署时间**：调整区域后需要重新部署，可能需要 2-5 分钟
2. **数据迁移**：如果使用了持久化存储，可能需要迁移数据
3. **环境变量**：确保所有环境变量已正确配置
4. **API Key 验证**：部署后验证所有 API Key 是否正常工作

---

## 📊 其他优化

### 已实施的优化

1. ✅ **增加 Bocha API 超时时间**：从 30 秒增加到 60 秒
2. ✅ **添加网络诊断日志**：记录每次请求的耗时
3. ✅ **改进错误处理**：区分超时、连接错误和其他网络问题

### 后续建议

1. 🔄 监控网络延迟，确认改善效果
2. 🔄 如果问题持续，考虑替换为国际 API（Tavily/Perplexity）
3. 🔄 考虑使用 CDN 或代理服务器进一步优化

---

**最后更新**：2025-11-11
**状态**: ✅ 已调整，等待验证

