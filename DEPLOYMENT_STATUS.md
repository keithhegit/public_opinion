# é¡¹ç›®éƒ¨ç½²çŠ¶æ€

## ğŸ“Š å½“å‰éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯å±‚                                â”‚
â”‚  Cloudflare Pages (å·²ç›‘å¬ Git ä»“åº“)                      â”‚
â”‚  - è‡ªåŠ¨éƒ¨ç½²                                              â”‚
â”‚  - å…¨çƒ CDN åŠ é€Ÿ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API ç®¡ç†å±‚                             â”‚
â”‚  Cloudflare Workers                                     â”‚
â”‚  - API è·¯ç”±å’Œè½¬å‘                                        â”‚
â”‚  - è¯·æ±‚ä»£ç†åˆ° Python åç«¯                                 â”‚
â”‚  - å·²ç§»é™¤ KV ç¼“å­˜ï¼ˆç›´æ¥è®¿é—®åç«¯ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åç«¯æœåŠ¡å±‚                              â”‚
â”‚  HK è¿œç¨‹æœåŠ¡å™¨ (14.136.93.109)                           â”‚
â”‚  - Python Flask åº”ç”¨                                     â”‚
â”‚  - å„ Engine æ¨¡å—æ‰§è¡Œ                                    â”‚
â”‚  - SocketIO å®æ—¶é€šä¿¡                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å­˜å‚¨å±‚                              â”‚
â”‚  æ•°æ®åº“ï¼šæœªéƒ¨ç½²                                          â”‚
â”‚  - MySQL/PostgreSQL (å¾…é…ç½®)                            â”‚
â”‚  - MindSpider æ•°æ®åº“ (å¾…åˆå§‹åŒ–)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ éƒ¨ç½²è¯¦æƒ…

### 1. å‰ç«¯éƒ¨ç½² - Cloudflare Pages

**çŠ¶æ€**: âœ… å·²éƒ¨ç½²å¹¶è¿è¡Œ

**é…ç½®**:
- **å¹³å°**: Cloudflare Pages
- **éƒ¨ç½²æ–¹å¼**: Git ä»“åº“è‡ªåŠ¨ç›‘å¬
- **è‡ªåŠ¨éƒ¨ç½²**: æ˜¯ï¼ˆç›‘å¬ä¸»åˆ†æ”¯ï¼‰
- **åŸŸå**: `bettafish-frontend.pages.dev` (æˆ–è‡ªå®šä¹‰åŸŸå)

**åŠŸèƒ½**:
- ä¸»ç•Œé¢å±•ç¤º
- Engine çŠ¶æ€ç›‘æ§
- å®æ—¶æ—¥å¿—æŸ¥çœ‹
- é…ç½®ç®¡ç†
- æŠ¥å‘Šç”Ÿæˆå’ŒæŸ¥çœ‹

**ä¼˜åŠ¿**:
- âœ… å…¨çƒ CDN åŠ é€Ÿ
- âœ… è‡ªåŠ¨ HTTPS
- âœ… é›¶é…ç½®éƒ¨ç½²
- âœ… å…è´¹é¢åº¦å……è¶³

---

### 2. API ç®¡ç† - Cloudflare Workers

**çŠ¶æ€**: âœ… å·²éƒ¨ç½²å¹¶è¿è¡Œ

**é…ç½®**:
- **å¹³å°**: Cloudflare Workers
- **Worker åç§°**: 
  - ç”Ÿäº§ç¯å¢ƒ: `bettafish-api-prod`
  - å¼€å‘ç¯å¢ƒ: `bettafish-api-dev`
- **Worker URL**: 
  - ç”Ÿäº§ç¯å¢ƒ: `https://bettafish-api-prod.keithhe2021.workers.dev`
  - å¼€å‘ç¯å¢ƒ: `https://bettafish-api-dev.keithhe2021.workers.dev`
- **éƒ¨ç½²æ–¹å¼**: æ‰‹åŠ¨éƒ¨ç½²ï¼ˆé€šè¿‡ `wrangler` CLIï¼‰
- **åç«¯ URL**: `https://api.keithhe.com` (HK æœåŠ¡å™¨)

**åŠŸèƒ½**:
- âœ… API è·¯ç”±ç®¡ç†
- âœ… è¯·æ±‚è½¬å‘åˆ° Python åç«¯
- âœ… CORS å¤„ç†
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹

**API ç«¯ç‚¹**:
```
GET  /api/health              # å¥åº·æ£€æŸ¥
GET  /api/status              # ç³»ç»ŸçŠ¶æ€
POST /api/start/:app          # å¯åŠ¨ Engine
POST /api/stop/:app           # åœæ­¢ Engine
GET  /api/output/:app         # è·å– Engine è¾“å‡º
POST /api/search              # æ‰§è¡Œæœç´¢
GET  /api/config              # è·å–é…ç½®
POST /api/config              # æ›´æ–°é…ç½®
GET  /api/forum/log           # è·å– Forum æ—¥å¿—
POST /api/forum/start         # å¯åŠ¨ Forum Engine
POST /api/forum/stop          # åœæ­¢ Forum Engine
POST /api/report/generate     # ç”ŸæˆæŠ¥å‘Š
GET  /api/report/status/:id    # æŸ¥è¯¢æŠ¥å‘ŠçŠ¶æ€
GET  /api/report/check        # æ£€æŸ¥å¼•æ“å°±ç»ªçŠ¶æ€
```

**æ¶æ„å˜æ›´**:
- âŒ **å·²ç§»é™¤**: Workers KV ç¼“å­˜
- âœ… **å½“å‰**: ç›´æ¥è½¬å‘æ‰€æœ‰è¯·æ±‚åˆ° Python åç«¯
- âœ… **ä¼˜åŠ¿**: é¿å… KV ç”¨é‡é™åˆ¶ï¼Œç®€åŒ–æ¶æ„
- âš ï¸ **å½±å“**: å“åº”æ—¶é—´å¯èƒ½å¢åŠ  50-200msï¼ˆé€šå¸¸å¯æ¥å—ï¼‰

**éƒ¨ç½²å‘½ä»¤**:
```bash
cd bettafish-workers
npm run deploy        # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
npm run deploy:dev    # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
```

**ç¯å¢ƒå˜é‡é…ç½®**:
åœ¨ Cloudflare Dashboard ä¸­é…ç½®ï¼š
- `BACKEND_URL`: `https://api.keithhe.com`
- `BACKEND_TOKEN`: (å¯é€‰) åç«¯è®¤è¯ä»¤ç‰Œ
- `ENVIRONMENT`: `production` æˆ– `development`

---

### 3. åç«¯æœåŠ¡ - HK è¿œç¨‹æœåŠ¡å™¨

**çŠ¶æ€**: âœ… å·²éƒ¨ç½²å¹¶è¿è¡Œ

**æœåŠ¡å™¨ä¿¡æ¯**:
- **IP**: 14.136.93.109
- **åŸŸå**: api.keithhe.com
- **ä½ç½®**: é¦™æ¸¯
- **æœåŠ¡**: Python Flask åº”ç”¨

**æœåŠ¡ç®¡ç†**:
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status bettafish

# å¯åŠ¨æœåŠ¡
sudo systemctl start bettafish

# åœæ­¢æœåŠ¡
sudo systemctl stop bettafish

# é‡å¯æœåŠ¡
sudo systemctl restart bettafish

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u bettafish -f
```

**Engine æ¨¡å—**:
- âœ… Insight Engine
- âœ… Media Engine
- âœ… Query Engine
- âœ… Report Engine (ç­‰å¾…å…¶ä»–å¼•æ“å®Œæˆåå¯åŠ¨)
- âœ… Forum Engine
- âœ… MindSpider (å¾…é…ç½®æ•°æ®åº“)

**ç«¯å£é…ç½®**:
- Flask åº”ç”¨: 5000 (å†…éƒ¨)
- Nginx åå‘ä»£ç†: 80/443 (å¤–éƒ¨)
- Streamlit åº”ç”¨: 8501-8503 (å†…éƒ¨)

**SSL/TLS**:
- âœ… HTTPS å·²é…ç½®
- âœ… Cloudflare SSL Flexible æ¨¡å¼
- âœ… è¯ä¹¦è‡ªåŠ¨ç»­æœŸ

---

### 4. æ•°æ®åº“ - æœªéƒ¨ç½²

**çŠ¶æ€**: âš ï¸ å¾…éƒ¨ç½²

**éœ€è¦é…ç½®çš„æ•°æ®åº“**:

#### 4.1 ä¸»æ•°æ®åº“ (MySQL/PostgreSQL)
- **ç”¨é€”**: å­˜å‚¨åº”ç”¨ä¸»æ•°æ®
- **çŠ¶æ€**: æœªé…ç½®
- **é…ç½®ä½ç½®**: `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯

#### 4.2 MindSpider æ•°æ®åº“
- **ç”¨é€”**: å­˜å‚¨ MindSpider çˆ¬è™«æ•°æ®
- **çŠ¶æ€**: æœªåˆå§‹åŒ–
- **è¡¨ç»“æ„**:
  - `daily_topics` - æ¯æ—¥è¯é¢˜
  - `daily_news` - æ¯æ—¥æ–°é—»
- **åˆå§‹åŒ–**: é€šè¿‡ `/api/mindspider/init_db` ç«¯ç‚¹

**æ•°æ®åº“é€‰é¡¹**:
1. **æœ¬åœ° MySQL/PostgreSQL** (åœ¨ HK æœåŠ¡å™¨ä¸Š)
2. **äº‘æ•°æ®åº“æœåŠ¡** (å¦‚ Railway, Supabase)
3. **Cloudflare D1** (SQLiteï¼Œé€‚åˆè½»é‡çº§æ•°æ®)

---

## ğŸ”„ éƒ¨ç½²æµç¨‹

### å‰ç«¯éƒ¨ç½²æµç¨‹

1. **ä»£ç æ¨é€**:
   ```bash
   git add .
   git commit -m "Update frontend"
   git push
   ```

2. **è‡ªåŠ¨éƒ¨ç½²**:
   - Cloudflare Pages è‡ªåŠ¨æ£€æµ‹ Git æ¨é€
   - è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²
   - éƒ¨ç½²å®Œæˆåè‡ªåŠ¨æ›´æ–°

### Workers API éƒ¨ç½²æµç¨‹

1. **ä»£ç ä¿®æ”¹**:
   ```bash
   cd bettafish-workers
   # ä¿®æ”¹ä»£ç 
   ```

2. **æœ¬åœ°æµ‹è¯•** (å¯é€‰):
   ```bash
   npm run dev
   ```

3. **éƒ¨ç½²åˆ°ç”Ÿäº§**:
   ```bash
   npm run deploy
   ```

4. **éªŒè¯éƒ¨ç½²**:
   ```bash
   curl https://bettafish-api-prod.keithhe2021.workers.dev/api/health
   ```

### åç«¯éƒ¨ç½²æµç¨‹

1. **SSH è¿æ¥åˆ°æœåŠ¡å™¨**:
   ```bash
   ssh bettafish@14.136.93.109
   ```

2. **æ›´æ–°ä»£ç **:
   ```bash
   cd /home/bettafish/Public_Opinion/BettaFish-main
   git pull
   ```

3. **æ›´æ–°ç¯å¢ƒå˜é‡** (å¦‚éœ€è¦):
   ```bash
   nano .env
   ```

4. **é‡å¯æœåŠ¡**:
   ```bash
   sudo systemctl restart bettafish
   ```

5. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**:
   ```bash
   sudo systemctl status bettafish
   ```

---

## ğŸ”§ é…ç½®ç®¡ç†

### Workers ç¯å¢ƒå˜é‡

åœ¨ Cloudflare Dashboard ä¸­é…ç½®ï¼š
1. è¿›å…¥ **Workers & Pages**
2. é€‰æ‹© **bettafish-api-prod**
3. ç‚¹å‡» **Settings** â†’ **Variables and Secrets**
4. é…ç½®ä»¥ä¸‹å˜é‡ï¼š
   - `BACKEND_URL`: `https://api.keithhe.com`
   - `ENVIRONMENT`: `production`

### åç«¯ç¯å¢ƒå˜é‡

åœ¨ HK æœåŠ¡å™¨ä¸Šçš„ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š
```env
# LLM API Keys
INSIGHT_ENGINE_API_KEY=...
MEDIA_ENGINE_API_KEY=...
QUERY_ENGINE_API_KEY=...
REPORT_ENGINE_API_KEY=...

# Bocha API
BOCHA_WEB_SEARCH_API_KEY=sk-...

# æ•°æ®åº“é…ç½®
DB_HOST=...
DB_USER=...
DB_PASSWORD=...
DB_NAME=...
DB_PORT=3306
DB_DIALECT=mysql
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### Workers æ—¥å¿—

åœ¨ Cloudflare Dashboard ä¸­æŸ¥çœ‹ï¼š
1. è¿›å…¥ **Workers & Pages** â†’ **bettafish-api-prod**
2. ç‚¹å‡» **Logs** æ ‡ç­¾
3. æŸ¥çœ‹å®æ—¶æ—¥å¿—å’Œé”™è¯¯

### åç«¯æ—¥å¿—

åœ¨ HK æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹ï¼š
```bash
# æœåŠ¡æ—¥å¿—
sudo journalctl -u bettafish -f

# Engine æ—¥å¿—
tail -f /home/bettafish/Public_Opinion/BettaFish-main/logs/*.log
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### Workers API æ— æ³•è¿æ¥åç«¯

**ç—‡çŠ¶**: è¿”å› 503 æˆ– 1003 é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ `BACKEND_URL` æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
3. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å…è®¸ Cloudflare IP
4. æ£€æŸ¥ SSL/TLS é…ç½®

### åç«¯æœåŠ¡æ— æ³•å¯åŠ¨

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æœåŠ¡çŠ¶æ€: `sudo systemctl status bettafish`
2. æŸ¥çœ‹æ—¥å¿—: `sudo journalctl -u bettafish -n 50`
3. æ£€æŸ¥ç«¯å£å ç”¨: `netstat -tulpn | grep 5000`
4. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

### å‰ç«¯æ— æ³•è¿æ¥ Workers API

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ Workers æ˜¯å¦éƒ¨ç½²æˆåŠŸ
2. æ£€æŸ¥ CORS é…ç½®
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
4. éªŒè¯ API ç«¯ç‚¹æ˜¯å¦å¯è®¿é—®

---

## ğŸ“ å¾…åŠäº‹é¡¹

### é«˜ä¼˜å…ˆçº§
- [ ] é…ç½®å’Œéƒ¨ç½²æ•°æ®åº“ (MySQL/PostgreSQL)
- [ ] åˆå§‹åŒ– MindSpider æ•°æ®åº“
- [ ] é…ç½®æ•°æ®åº“è¿æ¥æ± 
- [ ] è®¾ç½®æ•°æ®åº“å¤‡ä»½ç­–ç•¥

### ä¸­ä¼˜å…ˆçº§
- [ ] é…ç½® Redis ç¼“å­˜ï¼ˆå¦‚æœåç«¯è´Ÿè½½è¿‡é«˜ï¼‰
- [ ] è®¾ç½®ç›‘æ§å’Œå‘Šè­¦
- [ ] ä¼˜åŒ– Workers API æ€§èƒ½
- [ ] é…ç½®æ—¥å¿—èšåˆå’Œåˆ†æ

### ä½ä¼˜å…ˆçº§
- [ ] å®ç° Workers API çš„è¯·æ±‚é™æµ
- [ ] æ·»åŠ  API è®¤è¯å’Œæˆæƒ
- [ ] å®ç° API ç‰ˆæœ¬ç®¡ç†
- [ ] ä¼˜åŒ–å‰ç«¯åŠ è½½æ€§èƒ½

---

## ğŸ”— ç›¸å…³é“¾æ¥

- **Cloudflare Dashboard**: https://dash.cloudflare.com
- **Workers æ–‡æ¡£**: https://developers.cloudflare.com/workers/
- **Pages æ–‡æ¡£**: https://developers.cloudflare.com/pages/
- **åç«¯æœåŠ¡å™¨**: https://api.keithhe.com

---

**æœ€åæ›´æ–°**: 2025-11-13
**ç»´æŠ¤è€…**: BettaFish å›¢é˜Ÿ

