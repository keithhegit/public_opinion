# 历史任务管理功能实现总结

## 功能概述

实现了完整的历史任务管理系统，包括：
1. 历史任务查看（任务列表、状态、时间）
2. 任务日志归档和查看
3. 醒目的新任务入口按钮
4. 清空当前任务状态功能

## 后端实现（BettaFish-main/app.py）

### 1. 任务存储结构
- **任务索引文件**: `tasks_history/tasks_index.json`
- **任务归档目录**: `tasks_history/{task_id}/`
- **统一任务ID**: 跨引擎关联的任务标识

### 2. 核心函数
- `load_tasks_index()`: 加载任务索引
- `save_tasks_index()`: 保存任务索引
- `save_task_to_index()`: 保存新任务到索引
- `archive_task_log()`: 归档任务日志（任务完成时自动调用）

### 3. API端点
- `GET /api/tasks/history`: 获取历史任务列表
- `GET /api/tasks/<task_id>`: 获取任务详细信息
- `GET /api/tasks/<task_id>/logs/<app_name>`: 获取指定任务的日志
- `POST /api/tasks/clear`: 清空当前任务状态

### 4. 任务生命周期
1. **任务创建**: 搜索开始时，创建统一任务ID并保存到索引
2. **任务执行**: 每个引擎执行时，关联到统一任务ID
3. **任务完成**: 引擎完成时，自动归档日志到 `tasks_history/{task_id}/{app_name}.log`
4. **任务查询**: 通过API查询历史任务和日志

## 前端实现

### 1. 新增组件
- `TasksHistoryDialog.tsx`: 历史任务列表对话框
- `TaskLogViewer.tsx`: 任务日志查看器

### 2. 修改组件
- `SearchSection.tsx`: 添加"历史任务"和"新任务"按钮
- `app/page.tsx`: 添加新任务清空逻辑
- `lib/api-client.ts`: 添加历史任务管理API方法

### 3. UI特性
- **历史任务按钮**: 蓝色边框，显示历史任务列表
- **新任务按钮**: 绿色边框，清空当前状态并提示
- **任务列表**: 显示任务查询、状态、时间、引擎信息
- **日志查看**: 支持查看每个引擎的归档日志，支持导出

## 使用流程

### 查看历史任务
1. 点击"📋 历史任务"按钮
2. 在对话框中查看历史任务列表
3. 点击"查看 {引擎} 日志"按钮查看具体日志
4. 在日志查看器中可以导出日志

### 开始新任务
1. 点击"✨ 新任务"按钮
2. 系统自动清空当前任务状态和日志
3. 显示Toast提示"已清空当前任务，可以开始新任务了"
4. 输入新的搜索查询并执行

## 技术细节

### 任务归档逻辑
- 任务完成时，从日志文件中提取任务相关日志（从"新任务开始"标记开始）
- 只保存任务执行期间的日志，不包含引擎启动日志
- 每个引擎的日志单独归档

### 任务索引管理
- 最多保留100个历史任务
- 新任务插入到列表最前面
- 任务状态包括：running, completed, error

### 前端状态管理
- 使用React Hooks管理对话框状态
- 通过API客户端统一管理API调用
- Toast通知提供用户反馈

## 文件清单

### 后端
- `BettaFish-main/app.py`: 添加历史任务管理函数和API端点

### 前端
- `bettafish-frontend/components/TasksHistoryDialog.tsx`: 历史任务对话框
- `bettafish-frontend/components/TaskLogViewer.tsx`: 日志查看器
- `bettafish-frontend/components/SearchSection.tsx`: 添加按钮和对话框集成
- `bettafish-frontend/app/page.tsx`: 添加新任务清空逻辑
- `bettafish-frontend/lib/api-client.ts`: 添加历史任务API方法

## 测试建议

1. **创建任务**: 执行一次搜索，验证任务被保存到索引
2. **查看历史**: 打开历史任务对话框，验证任务列表显示
3. **查看日志**: 点击查看日志按钮，验证日志内容正确
4. **新任务**: 点击新任务按钮，验证状态被清空
5. **导出日志**: 在日志查看器中导出日志，验证文件下载

## 注意事项

1. 任务归档在引擎完成时自动执行，无需手动操作
2. 历史任务最多保留100个，超出部分会被删除
3. 日志归档只保存任务执行期间的日志，启动日志保留在原始日志文件中
4. 新任务按钮会清空所有引擎的日志和状态，请谨慎使用

